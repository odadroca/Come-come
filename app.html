<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Come-Come - Family meal tracking for neuro-divergent children">
    <title>Come-Come</title>
    
    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/assets/styles.css">
    
    <!-- PWA manifest -->
    <link rel="manifest" href="/assets/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <main class="container">
                <article>
                    <header>
                        <h1>üçΩÔ∏è <span data-i18n="app.name">Come-Come</span></h1>
                        <p data-i18n="login.select_role">Select your role to continue</p>
                    </header>
                    
                    <div class="role-selector">
                        <button type="button" class="role-btn" data-role="child">
                            <span class="role-icon">üßí</span>
                            <span class="role-label" data-i18n="login.child">Child</span>
                        </button>
                        <button type="button" class="role-btn" data-role="guardian">
                            <span class="role-icon">üë´</span>
                            <span class="role-label" data-i18n="login.guardian">Guardian</span>
                        </button>
                    </div>
                    
                    <form id="loginForm" style="display: none;">
                        <label for="userId">
                            <span data-i18n="login.select_user">Select User</span>
                            <select id="userId" required></select>
                        </label>
                        
                        <label for="pin">
                            <span data-i18n="login.pin_label">PIN (4 digits)</span>
                            <input type="password" id="pin" inputmode="numeric" pattern="\d{4}" maxlength="4" required>
                        </label>
                        
                        <button type="submit" data-i18n="login.submit">Log In</button>
                        <button type="button" onclick="app.showRoleSelector()" data-i18n="login.back">Back</button>
                    </form>
                </article>
            </main>
        </div>
        
        <!-- Main App Screen -->
        <div id="mainScreen" class="screen" style="display: none;">
            <nav class="container-fluid">
                <ul>
                    <li><strong id="appTitle" data-i18n="app.name">Come-Come</strong></li>
                </ul>
                <ul>
                    <li>
                        <select id="localeSwitcher" onchange="app.switchLocale()" title="Language">
                            <!-- Options populated dynamically from /i18n/locales by loadLocale() -->
                        </select>
                    </li>
                    <li><span id="userGreeting"></span></li>
                    <li><button class="secondary" onclick="app.logout()" data-i18n="logout">Logout</button></li>
                </ul>
            </nav>
            
            <main class="container">
                <!-- Date Selector -->
                <div class="date-selector">
                    <label for="selectedDate">
                        <span data-i18n="date">Date</span>
                        <input type="date" id="selectedDate" onchange="app.loadMealsForDate()">
                    </label>
                </div>
                
                <!-- Meal Cards -->
                <div id="mealCards" class="meal-grid"></div>
                
                <!-- Daily Logs -->
                <details id="todaysLogs" open>
                    <summary id="todaysLogsLabel" data-i18n="logs.today">Logs for Today</summary>
                    <h5 data-i18n="logs.meals">Meals</h5>
                    <div id="todaysLogsContent"></div>
                    <h5 id="medicationSectionHeader" data-i18n="logs.medications">Medications</h5>
                    <div id="todaysMedsContent"><p data-i18n="logs.no_medications">No medication logs.</p></div>
                    <h5 data-i18n="logs.weight">Weight</h5>
                    <div id="todaysWeightContent"><p data-i18n="logs.no_weight">No weight logged.</p></div>
                </details>
                
                <!-- History -->
                <details id="history">
                    <summary data-i18n="logs.history">History (Last 7 Days)</summary>
                    <div id="historyContent"></div>
                </details>
                
                <!-- Guardian Section -->
                <div id="guardianSection" style="display: none;">
                    <details>
                        <summary data-i18n="guardian.tools">Guardian Tools</summary>
                        
                        <details>
                            <summary data-i18n="settings">Settings</summary>
                            <label>
                                <input type="checkbox" id="childSeesMedicationsToggle" onchange="app.toggleMedicationVisibility()">
                                <span data-i18n="settings.child_sees_meds">Children can see medication logs</span>
                            </label>
                            <p><small data-i18n="settings.child_sees_meds_help">When disabled, the medication section is completely hidden for child accounts.</small></p>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.medication">Medication Log</summary>
                            <form id="medicationForm" onsubmit="app.logMedication(event)">
                                <label>
                                    <span data-i18n="medication.medication">Medication</span>
                                    <select name="medication_id" required></select>
                                </label>
                                <label>
                                    <span data-i18n="medication.date">Date</span>
                                    <input type="date" name="log_date" required>
                                </label>
                                <label>
                                    <span data-i18n="medication.time">Time (optional)</span>
                                    <input type="time" name="log_time">
                                </label>
                                <label>
                                    <span data-i18n="medication.status">Status</span>
                                    <select name="status" required>
                                        <option value="taken" data-i18n="medication.status.taken">Taken</option>
                                        <option value="missed" data-i18n="medication.status.missed">Missed</option>
                                        <option value="skipped" data-i18n="medication.status.skipped">Skipped</option>
                                    </select>
                                </label>
                                <label>
                                    <span data-i18n="medication.notes">Notes</span>
                                    <textarea name="notes" maxlength="500"></textarea>
                                </label>
                                <button type="submit" data-i18n="medication.log">Log Medication</button>
                            </form>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.weight">Weight Log</summary>
                            <form id="weightForm" onsubmit="app.logWeight(event)">
                                <label>
                                    <span data-i18n="date">Date</span>
                                    <input type="date" name="weight_date" id="weightDate" required>
                                </label>
                                <label>
                                    <span data-i18n="weight.kg">Weight (kg)</span>
                                    <input type="number" step="0.01" min="0.01" max="999.99" name="weight_kg" required>
                                </label>
                                <button type="submit" data-i18n="weight.log">Log Weight</button>
                            </form>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.tokens">Guest Tokens (Clinician Access)</summary>
                            <button onclick="app.showCreateTokenForm()" data-i18n="token.create">Create New Token</button>
                            <div id="tokenList"></div>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.export">Export Report</summary>
                            <label>
                                <span data-i18n="report.range">Report Range</span>
                                <select id="reportRange">
                                    <option value="30" data-i18n="report.30days">Last 30 Days</option>
                                    <option value="all" data-i18n="report.all">Whole History (max 365 days)</option>
                                </select>
                            </label>
                            <button onclick="app.exportPDF()" data-i18n="report.download">Download PDF Report</button>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.backup">Backup & Restore</summary>
                            <h4 data-i18n="backup.create">Create Backup</h4>
                            <button onclick="app.createBackup()" data-i18n="backup.create_now">Create Backup Now</button>
                            
                            <h4 data-i18n="backup.available">Available Backups</h4>
                            <div id="backupList"></div>
                            
                            <h4 data-i18n="backup.stats">Database Statistics</h4>
                            <div id="dbStats"></div>
                            <button onclick="app.vacuumDatabase()" data-i18n="backup.vacuum">Optimize Database (VACUUM)</button>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.templates">Meal Templates</summary>
                            <div id="templateCatalog"></div>
                            <button onclick="app.showAddTemplateForm()" data-i18n="template.add">Add New Template</button>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.food_catalog">Food Catalog</summary>
                            <div id="foodCatalog"></div>
                            <button onclick="app.showAddFoodForm()" data-i18n="food.add">Add New Food</button>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.medication_catalog">Medication Catalog</summary>
                            <div id="medicationCatalog"></div>
                            <button onclick="app.showAddMedicationForm()" data-i18n="medication.add">Add New Medication</button>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.users">User Management</summary>
                            <div id="userManagement"></div>
                            <div class="user-mgmt-actions">
                                <button onclick="app.showAddChildForm()" data-i18n="user.add_child">Add Child</button>
                                <button class="secondary" onclick="app.showAddGuardianForm()" data-i18n="user.add_guardian">Add Guardian</button>
                            </div>
                        </details>
                        
                        <details>
                            <summary data-i18n="guardian.translations">Translations (i18n)</summary>
                            <div>
                                <label>
                                    <span data-i18n="i18n.locale">Locale</span>
                                    <select id="i18nLocaleSelect" onchange="app.loadTranslationsAdmin()">
                                        <!-- Options populated dynamically from /i18n/locales by loadLocale() -->
                                    </select>
                                </label>
                                <div id="translationsTable"></div>
                                <h5 data-i18n="i18n.add_edit">Add / Edit Translation</h5>
                                <form id="translationForm" onsubmit="app.submitTranslation(event)">
                                    <label>
                                        <span data-i18n="i18n.key">Key</span>
                                        <input type="text" name="t_key" id="translationKey" required placeholder="e.g. meal.breakfast">
                                    </label>
                                    <label>
                                        <span data-i18n="i18n.value">Value</span>
                                        <input type="text" name="t_value" id="translationValue" required placeholder="Translated text">
                                    </label>
                                    <button type="submit" data-i18n="i18n.save">Save Translation</button>
                                </form>
                            </div>
                        </details>
                    </details>
                </div>
            </main>
        </div>
        
        <!-- Meal Modal -->
        <dialog id="mealModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="app.closeMealModal()"></button>
                    <h3 id="mealModalTitle"></h3>
                </header>
                <form id="mealForm" onsubmit="app.submitMeal(event)">
                    <div id="foodQuantityInputs"></div>
                    <label>
                        <span data-i18n="meal.notes">Notes</span>
                        <textarea name="note" maxlength="500"></textarea>
                    </label>
                    <footer>
                        <button type="submit" data-i18n="meal.save">Save</button>
                        <button type="button" class="secondary" onclick="app.closeMealModal()" data-i18n="meal.cancel">Cancel</button>
                    </footer>
                </form>
            </article>
        </dialog>
        
        <!-- User Form Modal -->
        <dialog id="userModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="app.closeUserModal()"></button>
                    <h3 id="userModalTitle" data-i18n="user.add">Add User</h3>
                </header>
                <form id="userForm" onsubmit="app.submitUser(event)">
                    <input type="hidden" name="form_role" id="userFormRole">
                    <input type="hidden" name="form_user_id" id="userFormUserId">
                    <input type="hidden" name="form_mode" id="userFormMode">
                    <label>
                        <span data-i18n="user.name">Name</span>
                        <input type="text" name="name" id="userFormName" required minlength="1" maxlength="100">
                    </label>
                    <div id="userFormPinFields">
                        <label>
                            <span data-i18n="login.pin_label">PIN (4 digits)</span>
                            <input type="password" name="pin" id="userFormPin" inputmode="numeric" pattern="\d{4}" maxlength="4">
                        </label>
                        <label>
                            <span data-i18n="user.pin_confirm">Confirm PIN</span>
                            <input type="password" name="pin_confirm" id="userFormPinConfirm" inputmode="numeric" pattern="\d{4}" maxlength="4">
                        </label>
                    </div>
                    <label>
                        <span data-i18n="i18n.locale">Locale</span>
                        <select name="locale" id="userFormLocale">
                            <option value="en-UK">English (UK)</option>
                            <option value="pt-PT">Portugu√™s (PT)</option>
                        </select>
                    </label>
                    <footer>
                        <button type="submit" data-i18n="save">Save</button>
                        <button type="button" class="secondary" onclick="app.closeUserModal()" data-i18n="cancel">Cancel</button>
                    </footer>
                </form>
            </article>
        </dialog>
        
        <!-- PIN Reset Modal -->
        <dialog id="pinModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="app.closePinModal()"></button>
                    <h3 id="pinModalTitle" data-i18n="user.reset_pin">Reset PIN</h3>
                </header>
                <form id="pinForm" onsubmit="app.submitPinReset(event)">
                    <input type="hidden" name="pin_user_id" id="pinFormUserId">
                    <label>
                        <span data-i18n="user.new_pin">New PIN (4 digits)</span>
                        <input type="password" name="new_pin" id="pinFormNewPin" inputmode="numeric" pattern="\d{4}" maxlength="4" required>
                    </label>
                    <label>
                        <span data-i18n="user.confirm_new_pin">Confirm New PIN</span>
                        <input type="password" name="new_pin_confirm" id="pinFormNewPinConfirm" inputmode="numeric" pattern="\d{4}" maxlength="4" required>
                    </label>
                    <footer>
                        <button type="submit" data-i18n="user.reset_pin">Reset PIN</button>
                        <button type="button" class="secondary" onclick="app.closePinModal()" data-i18n="cancel">Cancel</button>
                    </footer>
                </form>
            </article>
        </dialog>
        
        <!-- Template Form Modal -->
        <dialog id="templateModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="app.closeTemplateModal()"></button>
                    <h3 id="templateModalTitle" data-i18n="template.add">Add Meal Template</h3>
                </header>
                <form id="templateCatalogForm" onsubmit="app.submitTemplate(event)">
                    <input type="hidden" name="tpl_id" id="tplFormId">
                    <input type="hidden" name="tpl_mode" id="tplFormMode">
                    <label>
                        <span data-i18n="template.name">Template Name</span>
                        <input type="text" name="tpl_name" id="tplFormName" required minlength="1" maxlength="100" placeholder="e.g. Breakfast">
                    </label>
                    <label>
                        <span data-i18n="template.icon">Icon (emoji)</span>
                        <input type="text" name="tpl_icon" id="tplFormIcon" maxlength="10" placeholder="e.g. üçû">
                    </label>
                    <label>
                        <span data-i18n="template.sort">Sort Order</span>
                        <input type="number" name="tpl_sort" id="tplFormSort" min="1" max="99" placeholder="Auto">
                    </label>
                    <footer>
                        <button type="submit" data-i18n="save">Save</button>
                        <button type="button" class="secondary" onclick="app.closeTemplateModal()" data-i18n="cancel">Cancel</button>
                    </footer>
                </form>
            </article>
        </dialog>
        
        <!-- Food Form Modal -->
        <dialog id="foodModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="app.closeFoodModal()"></button>
                    <h3 id="foodModalTitle" data-i18n="food.add">Add Food</h3>
                </header>
                <form id="foodForm" onsubmit="app.submitFood(event)">
                    <input type="hidden" name="food_id" id="foodFormId">
                    <input type="hidden" name="food_mode" id="foodFormMode">
                    <label>
                        <span data-i18n="food.name">Food Name</span>
                        <input type="text" name="food_name" id="foodFormName" required minlength="1" maxlength="100">
                    </label>
                    <label>
                        <span data-i18n="food.category">Category</span>
                        <select name="food_category" id="foodFormCategory" required>
                            <option value="starter" data-i18n="food.category.starter">Starter</option>
                            <option value="main" data-i18n="food.category.main">Main</option>
                            <option value="dessert" data-i18n="food.category.dessert">Dessert</option>
                            <option value="drink" data-i18n="food.category.drink">Drink</option>
                            <option value="snack" data-i18n="food.category.snack">Snack</option>
                        </select>
                    </label>
                    <footer>
                        <button type="submit" data-i18n="save">Save</button>
                        <button type="button" class="secondary" onclick="app.closeFoodModal()" data-i18n="cancel">Cancel</button>
                    </footer>
                </form>
            </article>
        </dialog>
        
        <!-- Medication Form Modal -->
        <dialog id="medicationModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="app.closeMedicationModal()"></button>
                    <h3 id="medicationModalTitle" data-i18n="medication.add">Add Medication</h3>
                </header>
                <form id="medicationCatalogForm" onsubmit="app.submitMedicationCatalog(event)">
                    <input type="hidden" name="med_id" id="medFormId">
                    <input type="hidden" name="med_mode" id="medFormMode">
                    <label>
                        <span data-i18n="medication.name">Medication Name</span>
                        <input type="text" name="med_name" id="medFormName" required minlength="1" maxlength="200" placeholder="e.g. Ritalin">
                    </label>
                    <label>
                        <span data-i18n="medication.dose">Dose</span>
                        <input type="text" name="med_dose" id="medFormDose" required minlength="1" maxlength="100" placeholder="e.g. 10mg">
                    </label>
                    <label>
                        <span data-i18n="medication.notes_optional">Notes (optional)</span>
                        <textarea name="med_notes" id="medFormNotes" maxlength="500" placeholder="e.g. Take with food"></textarea>
                    </label>
                    <footer>
                        <button type="submit" data-i18n="save">Save</button>
                        <button type="button" class="secondary" onclick="app.closeMedicationModal()" data-i18n="cancel">Cancel</button>
                    </footer>
                </form>
            </article>
        </dialog>
    </div>
    
    <script src="/assets/app.js?v=0.200"></script>
</body>
</html>
